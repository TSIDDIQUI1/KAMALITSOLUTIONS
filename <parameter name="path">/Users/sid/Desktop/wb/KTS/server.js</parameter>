<parameter name="content">/*
 * Kamal IT Solutions - Secure Express Server
 */

const express = require("express");
const https = require("https");
const http = require("http");
const path = require("path");
const cors = require("cors");
const helmet = require("helmet");
const compression = require("compression");
const fs = require("fs");
const nodemailer = require("nodemailer");
const rateLimit = require("express-rate-limit");
const mongoSanitize = require("express-mongo-sanitize");
const hpp = require("hpp");

// Load .env file
const envConfig = {};
const envFile = path.join(__dirname, ".env");
if (fs.existsSync(envFile)) {
  fs.readFileSync(envFile, "utf8")
    .split("\n")
    .forEach((line) => {
      const trimmed = line.trim();
      if (trimmed && !trimmed.startsWith("#")) {
        const [key, ...valueParts] = trimmed.split("=");
        if (key && valueParts.length)
          envConfig[key.trim()] = valueParts.join("=").trim();
      }
    });
}

const EMAIL_USER = envConfig.EMAIL_USER || "your-email@gmail.com";
const EMAIL_PASS = envConfig.EMAIL_PASS || "your-app-password";

const app = express();
const PORT = process.env.PORT || 3000;

// Rate limiting
const contactLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,
  max: 10,
  message: {
    success: false,
    message: "Too many form submissions, please try again in an hour.",
  },
});

const newsletterLimiter = rateLimit({
  windowMs: 24 * 60 * 60 * 1000,
  max: 5,
  message: {
    success: false,
    message: "Too many subscriptions, please try again tomorrow.",
  },
});

// Security headers with Helmet
app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: [
          "'self'",
          "'unsafe-inline'",
          "https://fonts.googleapis.com",
          "https://cdnjs.cloudflare.com",
        ],
        fontSrc: [
          "'self'",
          "https://fonts.gstatic.com",
          "https://cdnjs.cloudflare.com",
          "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/",
        ],
        scriptSrc: [
          "'self'",
          "'unsafe-inline'",
          "https://cdnjs.cloudflare.com",
        ],
        imgSrc: ["'self'", "data:", "https:", "blob:"],
        connectSrc: ["'self'"],
        frameAncestors: ["'none'"],
        formAction: ["'self'"],
        baseUri: ["'self'"],
        objectSrc: ["'none'"],
        upgradeInsecureRequests: [],
      },
    },
    noSniff: true,
    xssFilter: true,
    frameguard: { action: "deny" },
    hidePoweredBy: true,
    hsts: false, // Disabled for local development
    referrerPolicy: { policy: "strict-origin-when-cross-origin" },
  })
);

// Input sanitization
app.use(mongoSanitize());
app.use(hpp());

// XSS protection middleware
app.use((req, res, next) => {
  if (req.body) {
    for (const key in req.body) {
      if (typeof req.body[key] === "string") {
        req.body[key] = req.body[key]
          .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "")
          .replace(/javascript:/gi, "")
          .replace(/on\w+=/gi, "")
          .trim();
      }
    }
  }
  next();
});

// Request size limits
app.use(express.json({ limit: "10kb" }));
app.use(express.urlencoded({ extended: true, limit: "10kb" }));

app.use(compression());
app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST"],
    allowedHeaders: ["Content-Type"],
  })
);

app.use(express.static(path.join(__dirname, "public")));

const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: { user: EMAIL_USER, pass: EMAIL_PASS },
});

// Helper functions
function sanitizeInput(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "<")
    .replace(/>/g, ">")
    .replace(/"/g, """)
    .replace(/'/g, "&#x27;")
    .replace(/\//g, "&#x2F;")
    .trim();
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function saveMessageToFile(data) {
  const messagesFile = path.join(__dirname, "messages.json");
  let messages = [];
  if (fs.existsSync(messagesFile)) {
    try {
      messages = JSON.parse(fs.readFileSync(messagesFile, "utf8"));
    } catch (e) {
      messages = [];
    }
  }
  messages.push({
    id: Date.now(),
    timestamp: new Date().toISOString(),
    name: sanitizeInput(data.name),
    email: sanitizeInput(data.email),
    phone: sanitizeInput(data.phone || ""),
    subject: sanitizeInput(data.subject),
    message: sanitizeInput(data.message),
  });
  fs.writeFileSync(messagesFile, JSON.stringify(messages, null, 2));
}

async function sendEmailNotification(data) {
  try {
    await transporter.sendMail({
      from: EMAIL_USER,
      to: EMAIL_USER,
      subject: "New Contact: " + sanitizeInput(data.subject),
      html:
        "<h2>New Message</h2><p><strong>Name:</strong> " +
        sanitizeInput(data.name) +
        "</p><p><strong>Email:</strong> " +
        sanitizeInput(data.email) +
        "</p><p><strong>Message:</strong></p><p>" +
        sanitizeInput(data.message).replace(/\n/g, "<br>") +
        "</p>",
    });
  } catch (error) {
    console.log("Email error:", error.message);
  }
}

// Routes
app.get("/", (req, res) =>
  res.sendFile(path.join(__dirname, "public", "index.html"))
);
app.get("/about", (req, res) =>
  res.sendFile(path.join(__dirname, "public", "about.html"))
);
app.get("/services", (req, res) =>
  res.sendFile(path.join(__dirname, "public", "services.html"))
);
app.get("/contact", (req, res) =>
  res.sendFile(path.join(__dirname, "public", "contact.html"))
);

app.post("/api/contact", contactLimiter, async (req, res) => {
  try {
    const { name, email, phone, subject, message } = req.body;
    if (!name || !email || !subject || !message) {
      return res.status(400).json({
        success: false,
        message: "Please fill in all required fields.",
      });
    }
    if (!isValidEmail(email)) {
      return res.status(400).json({
        success: false,
        message: "Please enter a valid email address.",
      });
    }
    if (name.length < 2 || name.length > 100) {
      return res.status(400).json({
        success: false,
        message: "Name must be between 2 and 100 characters.",
      });
    }
    if (message.length < 10 || message.length > 5000) {
      return res.status(400).json({
        success: false,
        message: "Message must be between 10 and 5000 characters.",
      });
    }
    console.log("Contact form submission received");
    saveMessageToFile({ name, email, phone, subject, message });
    await sendEmailNotification({ name, email, phone, subject, message });
    res.json({
      success: true,
      message:
        "Thank you for your message! We will get back to you within 24 hours.",
    });
  } catch (error) {
    console.error("Contact form error:", error);
    res.status(500).json({
      success: false,
      message: "Something went wrong! Please try again later.",
    });
  }
});

app.post("/api/newsletter", newsletterLimiter, (req, res) => {
  const { email } = req.body;
  if (!email || !isValidEmail(email)) {
    return res
      .status(400)
      .json({ success: false, message: "Please enter a valid email address." });
  }
  const newsletterFile = path.join(__dirname, "newsletter.json");
  let subscriptions = [];
  if (fs.existsSync(newsletterFile)) {
    try {
      subscriptions = JSON.parse(fs.readFileSync(newsletterFile, "utf8"));
    } catch (e) {}
  }
  if (subscriptions.find((s) => s.email === email)) {
    return res.json({ success: true, message: "You are already subscribed!" });
  }
  subscriptions.push({
    email: sanitizeInput(email),
    timestamp: new Date().toISOString(),
  });
  fs.writeFileSync(newsletterFile, JSON.stringify(subscriptions, null, 2));
  console.log("Newsletter subscription:", email);
  res.json({ success: true, message: "Successfully subscribed!" });
});

app.use((req, res) =>
  res.status(404).sendFile(path.join(__dirname, "public", "index.html"))
);

app.use((err, req, res, next) => {
  console.error("Server error:", err.message);
  res.status(500).json({ success: false, message: "Something went wrong!" });
});

// Load SSL certificates (if they exist)
let sslOptions = null;
if (fs.existsSync(path.join(__dirname, "key.pem")) && 
    fs.existsSync(path.join(__dirname, "cert.pem"))) {
  sslOptions = {
    key: fs.readFileSync(path.join(__dirname, "key.pem")),
    cert: fs.readFileSync(path.join(__dirname, "cert.pem")),
  };
}

// Create HTTP server
const httpServer = http.createServer(app);

// Create HTTPS server if SSL certs exist
let httpsServer = null;
if (sslOptions) {
  httpsServer = https.createServer(sslOptions, app);
}

// Start servers
httpServer.listen(PORT, "0.0.0.0", () => {
  console.log(
    "\nKamal IT Solutions - Server Running\n" +
      "============================================\n" +
      "Rate Limiting: Enabled\n" +
      "XSS Protection: Enabled\n" +
      "SQL Injection Prevention: Enabled\n" +
      "Security Headers: Enabled\n" +
      "\nServer running on http://localhost:" +
      PORT +
      "\n"
  );
});

// Also start HTTPS server if SSL is configured
if (httpsServer) {
  httpsServer.listen(PORT, "0.0.0.0", () => {
    console.log("HTTPS available on https://localhost:" + PORT + "\n");
  });
}

module.exports = app;
</parameter>
